generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Seller {
  phoneNumber   String   @id @db.VarChar(20) @map("phone_number")
  name          String?  @db.Text
  city          String?  @db.Text
  catalogueUrl  String?  @db.Text @map("catalogue_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  products    Product[] @relation("SellerProducts")
  scanLogs    ScanLog[] @relation("SellerScanLogs")

  @@map("sellers")
}

model Product {
  id                String    @id @db.Text
  sellerPhone       String    @db.VarChar(20) @map("seller_phone")
  seller            Seller    @relation("SellerProducts", fields: [sellerPhone], references: [phoneNumber])

  // Raw data from scraper
  rawName           String?   @db.Text @map("raw_name")
  rawDescription    String?   @db.Text @map("raw_description")
  priceRaw          Decimal?  @db.Decimal(12, 2) @map("price_raw")
  currency          String?   @db.VarChar(10)
  availability      String?   @db.Text

  // LLM-enriched data
  modelName         String?   @map("model_name")
  storageGb         String?   @map("storage_gb")
  color             String?
  warranty          String?

  // State / tracking
  dataHash          String?   @map("data_hash")
  isActive          Boolean   @default(true) @map("is_active")
  firstSeenAt       DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt        DateTime  @default(now()) @map("last_seen_at")
  lastModifiedAt    DateTime? @map("last_modified_at")

  historyEntries    ProductHistory[]

  @@index([sellerPhone])
  @@index([sellerPhone, isActive])
  @@index([lastModifiedAt])
  @@map("products")
}

model ProductHistory {
  historyId  Int      @id @default(autoincrement()) @map("history_id")
  productId  String   @db.Text @map("product_id")
  recordedAt DateTime @default(now()) @map("recorded_at")
  changeType String   @db.VarChar(20) @map("change_type")
  snapshot   Json     @map("snapshot")

  product    Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@map("product_history")
}

model ScanLog {
  id              Int      @id @default(autoincrement())
  sellerPhone     String   @db.VarChar(20) @map("seller_phone")
  seller          Seller   @relation("SellerScanLogs", fields: [sellerPhone], references: [phoneNumber])
  scanTime        DateTime @default(now()) @map("scan_time")
  productsFound   Int      @map("products_found")
  productsNew     Int      @map("products_new")
  productsUpdated Int      @map("products_updated")

  @@index([sellerPhone, scanTime])
  @@map("scan_logs")
}

// Scraper run logs for tracking cron jobs and manual runs
model ScraperRun {
  id          Int      @id @default(autoincrement())
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  status      String   @db.VarChar(20) // RUNNING, COMPLETED, FAILED, AUTH_REQUIRED
  triggerType String   @db.VarChar(20) @map("trigger_type") // MANUAL, SCHEDULED
  output      String?  @db.Text // Full log output
  errorMessage String? @db.Text @map("error_message")
  sellersProcessed Int @default(0) @map("sellers_processed")
  productsScraped  Int @default(0) @map("products_scraped")

  @@index([startedAt])
  @@index([status])
  @@map("scraper_runs")
}

// Scheduler configuration
model SchedulerConfig {
  id        Int      @id @default(1) // Single row config
  enabled   Boolean  @default(false)
  cronExpr  String   @db.VarChar(50) @map("cron_expr") @default("0 9,21 * * *") // Default: 9am and 9pm
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("scheduler_config")
}


